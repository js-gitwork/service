{% load i18n %}
<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans "Service System" %}</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        .asset-description {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            padding-left: 10px;
            font-style: italic;
            white-space: normal;
        }
        .asset-item.selected {
            background-color: #e3f2fd;
            border-left: 4px solid var(--primary-color);
            padding-left: 8px;
        }
        .asset-item:hover {
            background-color: #f5f5f5;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Flag + kreditering -->
    <div class="language-selector">
        <a href="#" class="lang-link" data-lang="da">
            <img src="/static/flag/dk.png" alt="Dansk" class="flag">
        </a>
        <a href="#" class="lang-link" data-lang="en">
            <img src="/static/flag/uk.png" alt="English" class="flag">
        </a>
        <a href="#" class="lang-link" data-lang="pl">
            <img src="/static/flag/pl.png" alt="Polski" class="flag">
        </a>
        <a href="#" class="lang-link" data-lang="de">
            <img src="/static/flag/de.png" alt="Deutsch" class="flag">
        </a>
    </div>
    <p class="credit-text">Flag: <a href="https://flagpedia.net" target="_blank">Flagpedia</a></p>

    <!-- Søgefelt + Scan QR-knap -->
    <input type="text" id="search" class="search-input" placeholder="Søg efter aktiv eller scan QR...">
    <button id="scan-btn" class="btn btn-primary" data-i18n="scan-qr">Scan QR-kode</button>

    <!-- Asset-liste -->
    <div id="asset-list-container" class="asset-list-container">
        <div id="asset-list" class="asset-list"></div>
    </div>

    <!-- Formular med SKJULT SPROG-FELT -->
    <form id="report-form" class="report-form">
        <input type="hidden" id="sprog-input" name="sprog" value="da">  <!-- Skjult sprog-felt -->
        <div class="form-group">
            <label for="description">Fejlbeskrivelse for: <strong id="selected-asset-label">Ingen valgt</strong></label>
            <textarea id="description" class="form-control" rows="3" required></textarea>
        </div>
        <div class="button-group">
            <button type="button" id="camera-btn" class="btn btn-secondary" data-i18n="choose-image">Billede</button>
            <button type="submit" class="btn btn-primary" data-i18n="submit-report">Indsend rapport</button>
        </div>
    </form>

    <!-- Billede-preview -->
    <img id="preview" class="image-preview hidden" alt="Preview">

    <script>
   // Oversættelser
   const translations = {
    da: {
        "scan-qr": "Scan QR-kode",
        "choose-image": "Foto",  // Ændret fra "Vælg billede" → "Foto"
        "submit-report": "Indsend rapport",
        "search-placeholder": "Søg efter aktiv eller scan QR...",
        "asset-list-empty": "Ingen aktiver fundet",
        "report-submitted": "Rapport indsendt!",
        "no-asset-selected": "Ingen aktiv valgt"
    },
    en: {
        "scan-qr": "Scan QR code",
        "choose-image": "Photo",  // Engelsk
        "submit-report": "Submit report",
        "search-placeholder": "Search for asset or scan QR...",
        "asset-list-empty": "No assets found",
        "report-submitted": "Report submitted!",
        "no-asset-selected": "No asset selected"
    },
    pl: {
        "scan-qr": "Zeskanuj kod QR",
        "choose-image": "Zdjęcie",  // Polsk for "foto" (korrekt stavemåde)
        "submit-report": "Wyślij raport",
        "search-placeholder": "Wyszukaj aktywo lub zeskanuj kod QR...",
        "asset-list-empty": "Nie znaleziono aktywów",
        "report-submitted": "Raport wysłany!",
        "no-asset-selected": "Nie wybrano aktywa"
    },
    de: {
        "scan-qr": "QR-Code scannen",
        "choose-image": "Foto",  // Tysk for "foto" (korrekt stavemåde)
        "submit-report": "Bericht einreichen",
        "search-placeholder": "Nach Asset suchen oder QR-Code scannen...",
        "asset-list-empty": "Keine Assets gefunden",
        "report-submitted": "Bericht eingereicht!",
        "no-asset-selected": "Kein Asset ausgewählt"
    }
   };

        // Global variabel til valgt aktiv og sprog
        let selectedAssetVPID = null;
        let currentLang = 'da';

        // Opdater skjult sprog-felt + tekster ved flag-klik
        document.querySelectorAll('.lang-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                currentLang = this.dataset.lang;
                document.getElementById('sprog-input').value = currentLang;  // Opdater skjult felt
                updateTexts();
                console.log("Sprog opdateret til:", currentLang);  // Debug
            });
        });

        // Opdater tekster baseret på sprog
        function updateTexts() {
            document.getElementById('scan-btn').textContent = translations[currentLang]["scan-qr"];
            document.getElementById('camera-btn').textContent = translations[currentLang]["choose-image"];
            document.querySelector('[data-i18n="submit-report"]').textContent = translations[currentLang]["submit-report"];
            document.getElementById('search').placeholder = translations[currentLang]["search-placeholder"];
            document.getElementById('selected-asset-label').textContent = selectedAssetVPID || translations[currentLang]["no-asset-selected"];
        }

        // Hent og vis aktiver
        async function loadAssets(searchTerm = '') {
            const assetList = document.getElementById('asset-list');
            try {
                const url = searchTerm ? `/api/assets/?search=${encodeURIComponent(searchTerm)}` : '/api/assets/';
                const response = await fetch(url);
                const assets = await response.json();
                assetList.innerHTML = assets.length > 0
                    ? assets.map(asset =>
                        `<div class="asset-item ${selectedAssetVPID === asset.VPID ? 'selected' : ''}"
                             data-vpid="${asset.VPID}"
                             onclick="selectAsset('${asset.VPID}', this)">
                            <strong>${asset.VPID}: ${asset.name}</strong>
                            ${asset.description ? `<div class="asset-description">${asset.description}</div>` : `<div class="asset-description">${translations[currentLang]["asset-list-empty"].replace("aktiver", "beskrivelse")}</div>`}
                        </div>`
                    ).join('')
                    : `<div class="asset-item">${translations[currentLang]["asset-list-empty"]}</div>`;
            } catch (error) {
                console.error("Fejl:", error);
                assetList.innerHTML = `<div class="asset-item">${translations[currentLang]["asset-list-empty"]}</div>`;
            }
        }

        // Funktion til at håndtere valgt aktiv
        function selectAsset(vpid, element) {
            document.querySelectorAll('.asset-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedAssetVPID = vpid;
            document.getElementById('search').value = vpid;
            document.getElementById('selected-asset-label').textContent = vpid;
            updateTexts();
        }

        // Søgefunktion
        document.getElementById('search').addEventListener('input', function(e) {
            loadAssets(e.target.value.trim());
        });

        // Scan QR (simuleret)
        document.getElementById('scan-btn').addEventListener('click', function() {
            const simulatedQR = prompt(translations[currentLang]["search-placeholder"]);
            if (simulatedQR) {
                document.getElementById('search').value = simulatedQR;
                loadAssets(simulatedQR);
            }
        });

        // Kamera
        document.getElementById('camera-btn').addEventListener('click', function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('preview').src = event.target.result;
                        document.getElementById('preview').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        });

        // Indsend rapport (OPdateret med sprog-felt)
        document.getElementById('report-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const description = document.getElementById('description').value;
            const preview = document.getElementById('preview');
            const vpid = selectedAssetVPID || document.getElementById('search').value.trim();

            if (!vpid) {
                alert(translations[currentLang]["no-asset-selected"]);
                return;
            }

            const imageData = preview.classList.contains('hidden') ? null : preview.src;
            const sprog = document.getElementById('sprog-input').value;  // Hent sprog fra skjult felt

            try {
                const response = await fetch('/api/reports/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        VPID: vpid,
                        description: description,
                        image: imageData,
                        sprog: sprog  // Send sprog med!
                    })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    alert(translations[currentLang]["report-submitted"]);
                    e.target.reset();
                    preview.classList.add('hidden');
                    selectedAssetVPID = null;
                    document.getElementById('selected-asset-label').textContent = translations[currentLang]["no-asset-selected"];
                    loadAssets();
                } else {
                    alert(data.message || "Fejl ved indsendelse");
                }
            } catch (error) {
                alert("Fejl: " + error);
            }
        });

        // Indlæs alle aktiver ved siden start
        document.addEventListener('DOMContentLoaded', function() {
            updateTexts();
            loadAssets();
        });
    </script>
</body>
</html>
