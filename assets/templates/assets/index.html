<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fejlrapport</title>
    <link rel="stylesheet" href="/static/css/styles.css">  <!-- Din CSS-fil -->
    <!-- Til QR-scanner -->
    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <!-- Til oversættelse (Google Translate API) -->
    <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    <style>
        /* Midlertidig CSS (flyt til styles.css senere) */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .language-selector {
            display: flex;
            justify-content: center;
            padding: 10px;
            background-color: #3f51b5;
        }
        .scan-btn {
            display: block;
            margin: 10px auto;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
        }
        #search {
            width: 90%;
            margin: 10px auto;
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        #asset-list {
            height: 300px;
            overflow-y: scroll;
            background-color: white;
            margin: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .asset-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        #fejlbeskrivelse {
            width: 90%;
            margin: 10px auto;
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
            min-height: 100px;
        }
        .camera-btn, .submit-btn {
            display: block;
            margin: 10px auto;
            padding: 10px 20px;
            background-color: #3f51b5;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
        }
        #preview {
            max-width: 100%;
            margin: 10px auto;
            display: block;
        }
    </style>
</head>
<body>
    <!-- Sprogvalg (flag) -->
    <div class="language-selector" id="google_translate_element"></div>

    <!-- QR-scanner knap -->
    <button class="scan-btn" id="startScan">Scan QR-kode</button>
    <div id="scanner-container" style="display: none;">
        <video id="preview" style="width: 100%;"></video>
    </div>

    <!-- Søgefelt -->
    <input type="text" id="search" placeholder="Indtast VPID (f.eks. 101)">

    <!-- Liste over aktiver (filtreret) -->
    <div id="asset-list">
        <!-- Dynamisk indhold her -->
    </div>

    <!-- Fejlrapport-formular -->
    <textarea id="fejlbeskrivelse" placeholder="Beskriv fejlen..."></textarea>
    <button class="camera-btn" id="takePhoto">Tag billede</button>
    <input type="file" id="fileInput" accept="image/*" capture="camera" style="display: none;">
    <img id="preview" style="display: none; max-width: 100%;">
    <button class="submit-btn" id="submitReport">Indsend fejlrapport</button>

    <!-- Skjult felt til gemte billeder -->
    <input type="hidden" id="imageData" name="imageData">

    <!-- Scripts -->
    <script>
        // Sprogvalg
        function googleTranslateElementInit() {
            new google.translate.TranslateElement(
                {pageLanguage: 'da', includedLanguages: 'da,en,de,pl'},
                'google_translate_element'
            );
        }

        // QR-scanner
        document.getElementById('startScan').addEventListener('click', function() {
            const scannerContainer = document.getElementById('scanner-container');
            scannerContainer.style.display = 'block';
            Instascan.Camera.getCameras().then(cameras => {
                if (cameras.length > 0) {
                    const scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
                    scanner.addListener('scan', function(content) {
                        document.getElementById('search').value = content.replace('VPID: ', '');
                        scannerContainer.style.display = 'none';
                        filterAssets();
                    });
                    scanner.start(cameras[0]);
                } else {
                    alert('Ingen kamera fundet!');
                }
            });
        });

        // Søgefelt
        document.getElementById('search').addEventListener('input', filterAssets);

        // Hent aktiver fra backend
        async function fetchAssets() {
            const response = await fetch('/api/assets/');
            const assets = await response.json();
            renderAssets(assets);
        }

        // Filtrer aktiver
        function filterAssets() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const assets = document.querySelectorAll('.asset-item');
            assets.forEach(asset => {
                const vpid = asset.getAttribute('data-vpid').toLowerCase();
                asset.style.display = vpid.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // Vis aktiver
        function renderAssets(assets) {
            const container = document.getElementById('asset-list');
            container.innerHTML = assets.map(asset =>
                `<div class="asset-item" data-vpid="${asset.VPID}">${asset.name} (${asset.VPID})</div>`
            ).join('');
        }

        // Tag billede
        document.getElementById('takePhoto').addEventListener('click', function() {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('preview').src = event.target.result;
                    document.getElementById('preview').style.display = 'block';
                    document.getElementById('imageData').value = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Indsend fejlrapport
        document.getElementById('submitReport').addEventListener('click', async function() {
            const vpid = document.getElementById('search').value;
            const description = document.getElementById('fejlbeskrivelse').value;
            const imageData = document.getElementById('imageData').value;

            // Oversæt til dansk (hvis ikke allerede)
            const translatedDesc = await translateToDanish(description);

            const response = await fetch('/api/reports/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    VPID: vpid,
                    description: translatedDesc,
                    image: imageData
                })
            });

            if (response.ok) {
                alert('Fejlrapport indsendt!');
                document.getElementById('fejlbeskrivelse').value = '';
                document.getElementById('preview').style.display = 'none';
            } else {
                alert('Fejl ved indsendelse!');
            }
        });

        // Oversæt til dansk (Google Translate API)
        async function translateToDanish(text) {
            if (!text) return '';
            // Her skal du implementere oversættelse (se næste trin)
            return text; // Midlertidig placeholder
        }

        // Start
        fetchAssets();
    </script>
</body>
</html>
